<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard — Trámites DIE</title>

  <!-- CSS básico + DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin: 18px; background:#f6f8fb; color:#0f172a; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px; }
    header h1 { margin:0; font-size:20px; color:#0b5cff; }
    .controls { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .card { background:white; border-radius:8px; box-shadow:0 6px 18px rgba(15,23,42,0.06); padding:14px; }
    .row { display:flex; gap:12px; margin-bottom:12px; }
    #charts { display:flex; gap:12px; flex-wrap:wrap; }
    #chartStatus, #chartArea { flex:1 1 360px; min-height:260px; }
    #tableWrap { margin-top:12px; }
    .meta { color:#475569; font-size:13px; }
    .small { font-size:13px; color:#64748b; }
    label { font-size:13px; }
    select, input[type="date"] { padding:6px 8px; border-radius:6px; border:1px solid #e2e8f0; background:white; }
    button { background:#0b5cff; color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
    .muted { color:#64748b; font-size:13px; }
  </style>
</head>
<body>

<header>
  <div>
    <h1>Dashboard Secretaría de Desarrollo Económico — Trámites DIE</h1>
    <div class="small">Panel ejecutivo — muestra estatus, área, fecha y folio</div>
  </div>
  <div class="meta">Última actualización: <span id="lastUpdate">—</span></div>
</header>

<div class="row">
  <div class="card controls">
    <label>Área responsable
      <select id="filterArea">
        <option value="">Todas</option>
      </select>
    </label>

    <label>Resumen del estatus
      <select id="filterStatus">
        <option value="">Todos</option>
      </select>
    </label>

    <label>Desde
      <input type="date" id="filterFrom">
    </label>
    <label>Hasta
      <input type="date" id="filterTo">
    </label>

    <button id="btnRefresh">Actualizar</button>
  </div>
</div>

<div id="charts" class="row">
  <div id="chartStatus" class="card">
    <canvas id="pieStatus"></canvas>
  </div>
  <div id="chartArea" class="card">
    <canvas id="barArea"></canvas>
  </div>
</div>

<div id="tableWrap" class="card">
  <table id="recordsTable" class="display" style="width:100%">
    <thead>
      <tr>
        <th>Folio</th>
        <th>Fecha</th>
        <th>Área responsable</th>
        <th>Resumen del estatus</th>
        <th>Trámite</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Librerías -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
/* --------------- CONFIG: usar proxy Cloudflare --------------- */
const PROXY_URL = "https://still-tree-0730.julabxus.workers.dev/";
const BASE_ID = "appUO0ktN532Um6iO";
const TABLE_NAME = "Trámites DIE";
const PAGE_SIZE = 100;

/* -------------------- fetch desde proxy -------------------- */
async function fetchAllAirtableRecords() {
  const records = [];
  let offset = undefined;
  const encodedTable = encodeURIComponent(TABLE_NAME);

  do {
    const params = new URLSearchParams();
    params.set("pageSize", PAGE_SIZE);
    if (offset) params.set("offset", offset);

    const url = `${PROXY_URL}?base=${BASE_ID}&table=${encodedTable}&${params.toString()}`;
    const resp = await fetch(url);

    if (!resp.ok) {
      const text = await resp.text();
      throw new Error("Error Proxy: " + resp.status + " - " + text);
    }

    const data = await resp.json();
    records.push(...data.records);
    offset = data.offset;
  } while (offset);

  return records;
}

/* -------------------- procesar registros -------------------- */
function parseRecord(rec) {
  const f = rec.fields || {};
  return {
    id: rec.id,
    Folio: f["Folio"] || "",
    Fecha: f["Fecha"] || "",
    Area: f["Área responsable"] || f["Area responsable"] || f["Área"] || "",
    Status: f["Resumen del estatus"] || f["Resumen"] || f["Estatus"] || "",
    Tramite: f["Trámite"] || f["tramite"] || f["Tramite"] || ""
  };
}

/* -------------------- resto del dashboard -------------------- */
// (todo igual que antes)
let dataTable = null;
let pieChart = null;
let barChart = null;

function formatDateForTable(dateStr) {
  if (!dateStr) return "";
  const d = new Date(dateStr);
  if (!isNaN(d)) return d.toLocaleDateString();
  return dateStr;
}

function populateFilters(data) {
  const areaSet = new Set();
  const statusSet = new Set();
  data.forEach(r => { if (r.Area) areaSet.add(r.Area); if (r.Status) statusSet.add(r.Status); });

  const areaSel = document.getElementById("filterArea");
  const statusSel = document.getElementById("filterStatus");
  areaSel.innerHTML = '<option value="">Todas</option>';
  statusSel.innerHTML = '<option value="">Todos</option>';

  Array.from(areaSet).sort().forEach(a => {
    const opt = document.createElement("option"); opt.value = a; opt.textContent = a; areaSel.appendChild(opt);
  });
  Array.from(statusSet).sort().forEach(s => {
    const opt = document.createElement("option"); opt.value = s; opt.textContent = s; statusSel.appendChild(opt);
  });
}

function updateTable(data) {
  const tbody = $("#recordsTable tbody");
  tbody.empty();
  data.forEach(r => {
    const tr = `<tr>
      <td>${r.Folio}</td>
      <td>${formatDateForTable(r.Fecha)}</td>
      <td>${r.Area}</td>
      <td>${r.Status}</td>
      <td>${r.Tramite}</td>
    </tr>`;
    tbody.append(tr);
  });

  if (!dataTable) {
    dataTable = $("#recordsTable").DataTable({
      pageLength: 10,
      lengthChange: false,
      ordering: true
    });
  } else {
    dataTable.clear();
    dataTable.rows.add($("#recordsTable tbody tr")).draw();
  }
}

function updateCharts(data) {
  const statusCounts = {};
  const areaCounts = {};
  data.forEach(r => {
    const s = r.Status || "Sin estatus";
    const a = r.Area || "Sin área";
    statusCounts[s] = (statusCounts[s] || 0) + 1;
    areaCounts[a] = (areaCounts[a] || 0) + 1;
  });

  const statusLabels = Object.keys(statusCounts);
  const statusValues = Object.values(statusCounts);
  const areaLabels = Object.keys(areaCounts);
  const areaValues = Object.values(areaCounts);

  // Pie (estatus)
  if (!pieChart) {
    const ctx = document.getElementById("pieStatus").getContext("2d");
    pieChart = new Chart(ctx, {
      type: "pie",
      data: { labels: statusLabels, datasets: [{ data: statusValues }] },
      options: { plugins: { legend: { position: 'bottom' } } }
    });
  } else {
    pieChart.data.labels = statusLabels;
    pieChart.data.datasets[0].data = statusValues;
    pieChart.update();
  }

  // Bar (área)
  if (!barChart) {
    const ctx2 = document.getElementById("barArea").getContext("2d");
    barChart = new Chart(ctx2, {
      type: "bar",
      data: { labels: areaLabels, datasets: [{ label: "Trámites", data: areaValues }] },
      options: { indexAxis: 'y', plugins: { legend: { display: false } } }
    });
  } else {
    barChart.data.labels = areaLabels;
    barChart.data.datasets[0].data = areaValues;
    barChart.update();
  }
}

function applyFilters(records) {
  const area = document.getElementById("filterArea").value;
  const status = document.getElementById("filterStatus").value;
  const from = document.getElementById("filterFrom").value;
  const to = document.getElementById("filterTo").value;

  return records.filter(r => {
    if (area && r.Area !== area) return false;
    if (status && r.Status !== status) return false;
    if (from && new Date(r.Fecha) < new Date(from)) return false;
    if (to && new Date(r.Fecha) > new Date(to)) return false;
    return true;
  });
}

let cachedRecords = [];

async function refreshAll() {
  try {
    document.getElementById("lastUpdate").textContent = "Cargando...";
    const raw = await fetchAllAirtableRecords();
    const parsed = raw.map(parseRecord);
    cachedRecords = parsed;

    populateFilters(parsed);
    const filtered = applyFilters(parsed);
    updateTable(filtered);
    updateCharts(filtered);
    document.getElementById("lastUpdate").textContent = new Date().toLocaleString();
  } catch (err) {
    console.error(err);
    alert("Error al cargar datos: " + err.message);
    document.getElementById("lastUpdate").textContent = "Error";
  }
}

document.getElementById("btnRefresh").addEventListener("click", refreshAll);
document.querySelectorAll("#filterArea,#filterStatus,#filterFrom,#filterTo").forEach(el => {
  el.addEventListener("change", () => {
    const filtered = applyFilters(cachedRecords);
    updateTable(filtered);
    updateCharts(filtered);
  });
});

refreshAll();
setInterval(refreshAll, 60000);
</script>
</body>
</html>
