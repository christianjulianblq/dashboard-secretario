<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard — Trámites DIE</title>

  <!-- CSS básico + DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>
  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --muted:#64748b;
      --accent:#0b5cff;
      --text:#0f172a;
    }
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin: 18px; background:var(--bg); color:var(--text); }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px; flex-wrap:wrap; }
    header h1 { margin:0; font-size:20px; color:var(--accent); }
    .controls { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .card { background:var(--card); border-radius:8px; box-shadow:0 6px 18px rgba(15,23,42,0.06); padding:14px; }
    .row { display:flex; gap:12px; margin-bottom:12px; flex-wrap:wrap; }
    #charts { display:flex; gap:12px; flex-wrap:wrap; }
    #chartStatus, #chartArea { flex:1 1 360px; min-height:260px; }
    #tableWrap { margin-top:12px; overflow-x:auto; }
    .meta { color:#475569; font-size:13px; }
    .small { font-size:13px; color:var(--muted); }
    label { font-size:13px; display:flex; flex-direction:column; gap:6px; }
    select, input[type="date"] { padding:6px 8px; border-radius:6px; border:1px solid #e2e8f0; background:white; min-width:160px; }
    button { background:var(--accent); color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
    .muted { color:var(--muted); font-size:13px; }

    /* Table adjustments */
    table.dataTable thead th { background: transparent; font-weight:600; }
    #recordsTable { width:100%; border-collapse: collapse; font-size:14px; }
    #recordsTable td, #recordsTable th { padding:8px 10px; vertical-align:middle; }

    /* Mobile: transform table into card list */
    @media (max-width: 800px) {
      /* hide datatables controls that break layout */
      .dataTables_wrapper .dataTables_length, 
      .dataTables_wrapper .dataTables_filter {
        display:block;
        width:100%;
        margin-bottom:8px;
      }

      /* make charts stacked narrower */
      #charts { flex-direction:column; }
      #chartStatus, #chartArea { min-height:220px; }

      /* card-style rows */
      table.dataTable, table.dataTable thead, table.dataTable tbody, table.dataTable th, table.dataTable td, table.dataTable tr {
        display: block;
      }
      table.dataTable thead tr { position: absolute; top: -9999px; left: -9999px; }
      table.dataTable tbody tr {
        border: 1px solid #e6e9ef;
        margin: 0 0 12px 0;
        padding:10px;
        border-radius:8px;
        background:var(--card);
      }
      table.dataTable tbody td {
        display: flex;
        justify-content: space-between;
        padding: 6px 10px;
        border: none;
      }
      table.dataTable tbody td:before {
        content: attr(data-label);
        font-weight:600;
        color:var(--muted);
        margin-right:10px;
        display:inline-block;
        width:45%;
      }
    }

    /* small screens - reduce paddings */
    @media (max-width: 420px) {
      header h1 { font-size:18px; }
      select, input[type="date"] { min-width:130px; }
    }
  </style>
</head>
<body>

<header>
  <div>
    <h1>Dashboard Secretaría de Desarrollo Económico — Trámites DIE</h1>
    <div class="small">Panel ejecutivo — muestra estatus, área, fecha, folio, nombre y estatus.</div>
  </div>
  <div class="meta">Última actualización: <span id="lastUpdate">—</span></div>
</header>

<div class="row">
  <div class="card controls">
    <label>Área responsable
      <select id="filterArea">
        <option value="">Todas</option>
      </select>
    </label>

    <label>Resumen del estatus
      <select id="filterStatus">
        <option value="">Todos</option>
      </select>
    </label>

    <label>Desde
      <input type="date" id="filterFrom">
    </label>
    <label>Hasta
      <input type="date" id="filterTo">
    </label>

    <button id="btnRefresh">Actualizar</button>
  </div>
</div>

<div id="charts" class="row">
  <div id="chartStatus" class="card">
    <canvas id="pieStatus"></canvas>
  </div>
  <div id="chartArea" class="card">
    <canvas id="barArea"></canvas>
  </div>
</div>

<div id="tableWrap" class="card">
  <table id="recordsTable" class="display" style="width:100%">
    <thead>
      <tr>
        <th>Nombre del ciudadano</th>
        <th>Estatus</th>
        <th>Folio</th>
        <th>Fecha</th>
        <th>Área responsable</th>
        <th>Resumen del estatus</th>
        <th>Trámite</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Librerías -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
/* --------------- CONFIG: usar proxy Cloudflare --------------- */
const PROXY_URL = "https://still-tree-0730.julabxus.workers.dev/";
const BASE_ID = "appUO0ktN532Um6iO";
const TABLE_NAME = "Trámites DIE";
const PAGE_SIZE = 100;

/* -------------------- fetch desde proxy -------------------- */
async function fetchAllAirtableRecords() {
  const records = [];
  let offset = undefined;
  const encodedTable = encodeURIComponent(TABLE_NAME);

  do {
    const params = new URLSearchParams();
    params.set("pageSize", PAGE_SIZE);
    if (offset) params.set("offset", offset);

    const url = `${PROXY_URL}?base=${BASE_ID}&table=${encodedTable}&${params.toString()}`;
    const resp = await fetch(url);

    if (!resp.ok) {
      const text = await resp.text();
      throw new Error("Error Proxy: " + resp.status + " - " + text);
    }

    const data = await resp.json();
    records.push(...(data.records || []));
    offset = data.offset;
  } while (offset);

  return records;
}

/* -------------------- procesar registros -------------------- */
function parseRecord(rec) {
  const f = rec.fields || {};
  return {
    id: rec.id,
    NombreCiudadano: f["Nombre del ciudadano"] || f["Nombre del Ciudadano"] || f["Nombre"] || "",
    Estatus: f["Estatus"] || f["Estatus "] || "",
    Folio: f["Folio"] || "",
    Fecha: f["Fecha"] || "",
    Area: f["Área responsable"] || f["Area responsable"] || f["Área"] || "",
    Status: f["Resumen del estatus"] || f["Resumen"] || f["Estatus"] || "",
    Tramite: f["Trámite"] || f["tramite"] || f["Tramite"] || ""
  };
}

/* ---------------- UI: DataTable y Charts ---------------- */
let dataTable = null;
let pieChart = null;
let barChart = null;

function formatDateForTable(dateStr) {
  if (!dateStr) return "";
  const d = new Date(dateStr);
  if (!isNaN(d)) return d.toLocaleDateString();
  return dateStr;
}

function populateFilters(data) {
  const areaSet = new Set();
  const statusSet = new Set();
  data.forEach(r => { if (r.Area) areaSet.add(r.Area); if (r.Status) statusSet.add(r.Status); });

  const areaSel = document.getElementById("filterArea");
  const statusSel = document.getElementById("filterStatus");
  areaSel.innerHTML = '<option value="">Todas</option>';
  statusSel.innerHTML = '<option value="">Todos</option>';

  Array.from(areaSet).sort().forEach(a => {
    const opt = document.createElement("option"); opt.value = a; opt.textContent = a; areaSel.appendChild(opt);
  });
  Array.from(statusSet).sort().forEach(s => {
    const opt = document.createElement("option"); opt.value = s; opt.textContent = s; statusSel.appendChild(opt);
  });
}

function updateTable(data) {
  const tbody = $("#recordsTable tbody");
  tbody.empty();
  data.forEach(r => {
    // When in mobile (CSS) DataTables expects data-label attributes for each td;
    // we add data-label dynamically so the mobile card view shows labels.
    const tr = `<tr>
      <td data-label="Nombre">${escapeHtml(r.NombreCiudadano)}</td>
      <td data-label="Estatus">${escapeHtml(r.Estatus)}</td>
      <td data-label="Folio">${escapeHtml(r.Folio)}</td>
      <td data-label="Fecha">${escapeHtml(formatDateForTable(r.Fecha))}</td>
      <td data-label="Área">${escapeHtml(r.Area)}</td>
      <td data-label="Resumen">${escapeHtml(r.Status)}</td>
      <td data-label="Trámite">${escapeHtml(r.Tramite)}</td>
    </tr>`;
    tbody.append(tr);
  });

  if (!dataTable) {
    dataTable = $("#recordsTable").DataTable({
      pageLength: 10,
      lengthChange: false,
      ordering: true,
      // keep responsive behavior off because we handle it with CSS
      responsive: false,
      columnDefs: [
        { targets: [0,1], width: "18%" },
        { targets: [2,3,4], width: "15%" }
      ]
    });
  } else {
    dataTable.clear();
    dataTable.rows.add($("#recordsTable tbody tr")).draw();
  }
}

function updateCharts(data) {
  const statusCounts = {};
  const areaCounts = {};
  data.forEach(r => {
    const s = r.Status || "Sin estatus";
    const a = r.Area || "Sin área";
    statusCounts[s] = (statusCounts[s] || 0) + 1;
    areaCounts[a] = (areaCounts[a] || 0) + 1;
  });

  const statusLabels = Object.keys(statusCounts);
  const statusValues = Object.values(statusCounts);
  const areaLabels = Object.keys(areaCounts);
  const areaValues = Object.values(areaCounts);

  // Pie (estatus)
  if (!pieChart) {
    pieChart = new Chart(document.getElementById("pieStatus"), {
      type: "pie",
      data: { labels: statusLabels, datasets: [{ data: statusValues }] },
      options: { plugins: { legend: { position: 'bottom' } } }
    });
  } else {
    pieChart.data.labels = statusLabels;
    pieChart.data.datasets[0].data = statusValues;
    pieChart.update();
  }

  // Bar (área)
  if (!barChart) {
    barChart = new Chart(document.getElementById("barArea"), {
      type: "bar",
      data: { labels: areaLabels, datasets: [{ label: "Trámites", data: areaValues }] },
      options: { indexAxis: 'y', plugins: { legend: { display: false } } }
    });
  } else {
    barChart.data.labels = areaLabels;
    barChart.data.datasets[0].data = areaValues;
    barChart.update();
  }
}

/* -------------------- Filtrado y refresco -------------------- */
function applyFilters(records) {
  const area = document.getElementById("filterArea").value;
  const status = document.getElementById("filterStatus").value;
  const from = document.getElementById("filterFrom").value;
  const to = document.getElementById("filterTo").value;

  return records.filter(r => {
    if (area && r.Area !== area) return false;
    if (status && r.Status !== status) return false;
    if (from && new Date(r.Fecha) < new Date(from)) return false;
    if (to && new Date(r.Fecha) > new Date(to)) return false;
    return true;
  });
}

let cachedRecords = [];

/* -------------------- util -------------------- */
function escapeHtml(text){
  if (text === null || text === undefined) return "";
  return String(text)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

/* -------------------- main -------------------- */
async function refreshAll() {
  try {
    document.getElementById("lastUpdate").textContent = "Cargando...";
    const raw = await fetchAllAirtableRecords();
    const parsed = raw.map(parseRecord);
    cachedRecords = parsed;

    populateFilters(parsed);
    const filtered = applyFilters(parsed);
    updateTable(filtered);
    updateCharts(filtered);
    document.getElementById("lastUpdate").textContent = new Date().toLocaleString();
  } catch (err) {
    console.error(err);
    alert("Error al cargar datos: " + err.message);
    document.getElementById("lastUpdate").textContent = "Error";
  }
}

/* -------------------- eventos -------------------- */
document.getElementById("btnRefresh").addEventListener("click", refreshAll);
document.querySelectorAll("#filterArea,#filterStatus,#filterFrom,#filterTo").forEach(el => {
  el.addEventListener("change", () => {
    const filtered = applyFilters(cachedRecords);
    updateTable(filtered);
    updateCharts(filtered);
  });
});

refreshAll();
setInterval(refreshAll, 60000);
</script>
</body>
</html>
